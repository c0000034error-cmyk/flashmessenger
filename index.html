<!DOCTYPE html>
<html>
<head>
    <title>FlashMessenger</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        input, button { padding: 10px; margin: 5px; }
        .chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
        .user { padding: 5px; border-bottom: 1px solid #eee; cursor: pointer; }
    </style>
</head>
<body>
    <h2>FlashMessenger</h2>
    
    <div id="loginSection">
        <input type="text" id="username" placeholder="Username">
        <button onclick="register()">Register/Login</button>
    </div>

    <div id="chatSection" style="display:none">
        <input type="text" id="searchUser" placeholder="Search user..." oninput="searchUsers(this.value)">
        <div id="userList"></div>
        
        <div class="chat" id="chatBox"></div>
        <input type="text" id="messageInput" placeholder="Type message...">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = io('http://localhost:3001');
        let currentUser = null;
        let targetUser = null;

        async function register() {
            const username = document.getElementById('username').value;
            
            const response = await fetch('/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });
            
            const data = await response.json();
            if (data.success) {
                currentUser = data.user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('chatSection').style.display = 'block';
            }
        }

        async function searchUsers(username) {
            if (username.length < 2) return;
            
            const response = await fetch(`/search/${username}`);
            const users = await response.json();
            
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(user => 
                `<div class="user" onclick="selectUser(${user.id}, '${user.username}')">${user.username}</div>`
            ).join('');
        }

        function selectUser(userId, username) {
            targetUser = { id: userId, username };
            document.getElementById('chatBox').innerHTML = `<h3>Chat with ${username}</h3>`;
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message || !targetUser) return;

            const messageData = {
                from: currentUser.id,
                to: targetUser.id,
                text: message,
                timestamp: new Date()
            };

            socket.emit('send_message', messageData);
            addMessageToChat(messageData);
            document.getElementById('messageInput').value = '';
        }

        function addMessageToChat(message) {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `<div><b>You:</b> ${message.text}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        socket.on('receive_message', (message) => {
            if (message.to === currentUser.id) {
                addMessageToChat(message);
            }
        });
    </script>
</body>
</html>